(function () {
  'use strict';

  function styleInject(css, ref) {
    if ( ref === void 0 ) ref = {};
    var insertAt = ref.insertAt;

    if (!css || typeof document === 'undefined') { return; }

    var head = document.head || document.getElementsByTagName('head')[0];
    var style = document.createElement('style');
    style.type = 'text/css';

    if (insertAt === 'top') {
      if (head.firstChild) {
        head.insertBefore(style, head.firstChild);
      } else {
        head.appendChild(style);
      }
    } else {
      head.appendChild(style);
    }

    if (style.styleSheet) {
      style.styleSheet.cssText = css;
    } else {
      style.appendChild(document.createTextNode(css));
    }
  }

  var css_248z = "*{box-sizing:border-box}body,html{height:100%;margin:0;overflow:hidden;padding:0;width:100%}.style-module_speecher__ZAYi-{font-family:Inter var,Inter,-apple-system,\"system-ui\",system-ui,Segoe UI,Roboto,Helvetica Neue,Ubuntu,sans-serif}body{align-items:center;display:flex;flex-direction:column;justify-content:center;margin:0;overflow:hidden;padding:0}.style-module_button__jq3AX{background-color:#3c92dc;border:1px solid #266ebd;border-radius:4px;color:#fff;cursor:pointer;display:block;font-size:12px;font-weight:500;padding:8px;pointer-events:all;width:100%}.style-module_button__jq3AX:hover{background-color:#3282ce;border:1px solid #1f60ae}.style-module_row__H2sPc{display:flex;width:100%}.style-module_title__Hei5S{font-size:.9rem}.style-module_err__g8zge,.style-module_title__Hei5S{align-items:center;display:flex;flex-direction:column;justify-content:center;pointer-events:none;text-align:center;-webkit-user-select:none;-moz-user-select:none;user-select:none}.style-module_err__g8zge{background-color:hsla(0,100%,95%,.85);font-size:.8rem;height:100%;left:0;position:absolute;top:0;width:100%}.style-module_active__ssQXz{opacity:1;pointer-events:all}.style-module_inactive__gXEdI{opacity:.5;pointer-events:none}";
  var css = {"speecher":"style-module_speecher__ZAYi-","button":"style-module_button__jq3AX","row":"style-module_row__H2sPc","title":"style-module_title__Hei5S","err":"style-module_err__g8zge","active":"style-module_active__ssQXz","inactive":"style-module_inactive__gXEdI"};
  styleInject(css_248z);

  const Ret = window.Retool;
  let toggleBtn;
  let errWrapper;
  let isRec = false;
  const errors = {
    'not-allowed': 'You need to allow "Microphone" and "Storage and cookies" in Custom Component panel.',
    'no-speech': 'Stop due no speech around.'
  };
  const buildUI = model => {
    document.body.classList.add(css.speecher);
    errWrapper = document.createElement('div');
    errWrapper.classList.add(css.err);
    errWrapper.style.visibility = 'hidden';
    const speechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!speechRec) {
      errWrapper.style.visibility = 'visible';
      errWrapper.innerHTML = 'Your browser is not supported, sorry.';
    }
    const row = document.createElement('div');
    row.classList.add(css.row);
    document.body.append(row);
    const {
      labelStart = 'Start'
    } = model || {};
    toggleBtn = document.createElement('button');
    toggleBtn.textContent = labelStart;
    toggleBtn.classList.add(css.button);
    row.append(toggleBtn);
    toggleBtn.addEventListener('click', () => {
      if (isRec) {
        stopSpeecher();
        isRec = false;
      } else {
        if (!recognition) buildSpeecher(model);
        startSpeecher();
        isRec = true;
      }
    });
    document.body.append(errWrapper);
  };
  let inited = false;
  let recognition;
  let paused = false;
  let isError = false;
  const messages = [];
  const buildSpeecher = model => {
    const {
      continuous = false,
      interimResults = true,
      lang = 'en-US',
      maxAlternatives = 1,
      keepActive = true,
      labelStart = 'Start',
      labelStop = 'Stop'
    } = model || {};
    recognition = new webkitSpeechRecognition();
    recognition.continuous = continuous;
    recognition.interimResults = interimResults;
    recognition.lang = lang;
    recognition.maxAlternatives = maxAlternatives;
    recognition.onresult = event => {
      const res = event.results[0];
      const a = res[0];
      const msg = a.transcript.trim();
      if (res.isFinal) {
        messages.push(msg);
        Ret.modelUpdate({
          lastMessage: msg,
          messages
        });
      }
    };
    recognition.onstart = function () {
      errWrapper.style.visibility = 'hidden';
      isError = false;
      toggleBtn.textContent = labelStop;
    };
    recognition.onerror = function (event) {
      errWrapper.style.visibility = 'visible';
      errWrapper.innerHTML = errors[event.error];
      if (event.error === 'no-speech' && keepActive) ; else {
        errWrapper.style.visibility = 'visible';
        isError = true;
      }
    };
    recognition.onend = function () {
      toggleBtn.textContent = labelStart;
      if (isError) return;
      if (keepActive && !paused) startSpeecher();
    };
  };
  const startSpeecher = () => {
    paused = false;
    recognition.start();
  };
  const stopSpeecher = () => {
    paused = true;
    recognition.stop();
  };
  Ret.subscribe(_model => {
    const model = _model || {};
    if (!model?.lastMessage && !model?.messages) {
      console.log('Speech2Text: model changed from editor');
    }
    if (!inited) {
      buildUI(model);
      inited = true;
    }
  });

})();
